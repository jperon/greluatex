\ProvidesPackage{greluatex}

% Dépendances
\RequirePackage[autocompile]{gregoriotex}
\RequirePackage{keycommand}
\RequirePackage{environ}
\RequirePackage{luacode}
% Script lua
\directlua{dofile(kpse.find_file("greluatex.lua"))}

% Taille par défaut des partitions
\newcounter{factor}
\newcounter{tmpgre}

\NewEnviron{ecriregre}{%
\directlua{Ecrire(\luastringO{\BODY}, \luastring{\grefile})}
}

\newkeyenvironment{gre}[factor=\grefactor][autres]{%
\setcounter{factor}{\commandkey{factor}}
\stepcounter{tmpgre}
\def\grefile{tmp_gre/\alph{tmpgre}.gabc}
\ecriregre%
}{
\endecriregre%
{\setgrefactor{\arabic{factor}}\includescore{\grefile}}%
}
